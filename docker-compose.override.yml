services:
  # Local services are available on their ports:
  # - Backend: http://localhost:8000
  # - Frontend: http://localhost:5173
  # - Mailcatcher: http://localhost:1080
  #
  # Traefik is NOT used in development mode.
  # For production-like local setup with Traefik, use docker-compose.traefik.yml

  db:
    restart: 'no'
    ports:
      - '5432:5432'

  backend:
    restart: 'no'
    ports:
      - '8000:8000'
    build:
      context: ./backend
    command:
      - fastapi
      - run
      - --reload
      - 'app/main.py'
    develop:
      watch:
        - path: ./backend
          action: sync
          target: /app
          ignore:
            - ./backend/.venv
            - .venv
        - path: ./backend/pyproject.toml
          action: rebuild
    environment:
      SMTP_HOST: 'mailcatcher'
      SMTP_PORT: '1025'
      SMTP_TLS: 'false'
      EMAILS_FROM_EMAIL: 'noreply@example.com'
    # Traefik labels are ignored in dev mode (traefik-public network is not external)

  mailcatcher:
    image: schickling/mailcatcher
    ports:
      - '1080:1080'
      - '1025:1025'

  frontend:
    restart: 'no'
    ports:
      - '5173:5173' # Vite dev server port
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev # Use dev Dockerfile
      args:
        - VITE_API_URL=http://localhost:8000
        - VITE_YANDEX_MAPS_API_KEY=${VITE_YANDEX_MAPS_API_KEY}
    develop:
      watch:
        - path: ./frontend/src
          action: sync
          target: /app/src
        - path: ./frontend/package.json
          action: rebuild
        - path: ./frontend/vite.config.ts
          action: rebuild
    # Traefik labels are ignored in dev mode (traefik-public network is not external)

networks:
  traefik-public:
    # For local dev, don't expect an external Traefik network
    external: false
